<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cross Platform TTS with Highlight</title>
  <style>
    body {
      background:#0f1226;
      color:#fff;
      font-family:Arial, sans-serif;
      padding:20px;
    }
    #textDisplay span.active {
      background:yellow;
      color:#000;
    }
    #startOverlay {
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:rgba(15,18,38,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    #startOverlay button {
      padding:18px 26px;
      font-size:20px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      background:linear-gradient(90deg, #7c5cff, #9a7cff);
      color:#fff;
      font-weight:700;
    }
  </style>
</head>
<body>

  <h2>Cross Platform Text-to-Speech</h2>
  <div id="textDisplay"></div>
  <br/>
  <button onclick="speak()">Play</button>
  <button onclick="stop()">Stop</button>

  <script>
    const synth = window.speechSynthesis;
    let voices = [];
    let currentUtterance = null;
    let wordSpans = [];
    let fallbackTimer = null;

    const textDisplay = document.getElementById("textDisplay");
    const text = "Hello! This is a test for cross platform text to speech with word highlighting.";
    
    // split into spans
    function prepareText(t){
      textDisplay.innerHTML = "";
      wordSpans = t.split(" ").map(word=>{
        const span = document.createElement("span");
        span.textContent = word+" ";
        textDisplay.appendChild(span);
        return span;
      });
    }
    prepareText(text);

    function clearHighlights(){
      wordSpans.forEach(s=>s.classList.remove("active"));
    }

    function highlightByCharIndex(charIndex){
      let count = 0;
      for(let i=0;i<wordSpans.length;i++){
        count += wordSpans[i].textContent.length;
        if(charIndex < count){
          clearHighlights();
          wordSpans[i].classList.add("active");
          break;
        }
      }
    }

    function loadVoices(){
      voices = synth.getVoices();
    }
    loadVoices();
    if(speechSynthesis.onvoiceschanged!==undefined){
      speechSynthesis.onvoiceschanged=loadVoices;
    }

    function speak(){
      if(synth.speaking){ synth.cancel(); }
      clearHighlights();
      clearInterval(fallbackTimer);

      const utter = new SpeechSynthesisUtterance(text);
      currentUtterance = utter;

      if(voices.length>0) utter.voice = voices.find(v=>v.lang.startsWith("en")) || voices[0];
      utter.lang = utter.voice ? utter.voice.lang : "en-US";

      utter.onstart = ()=>{
        // fallback highlight for iOS/Android
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          let i = 0;
          fallbackTimer = setInterval(()=>{
            if(i<wordSpans.length){
              clearHighlights();
              wordSpans[i].classList.add("active");
              i++;
            } else {
              clearInterval(fallbackTimer);
            }
          }, 250); // approx 4 words/sec
        }
      };

      utter.onend = ()=>{
        clearHighlights();
        clearInterval(fallbackTimer);
      };

      utter.onerror = ()=>{
        clearHighlights();
        clearInterval(fallbackTimer);
      };

      utter.onboundary = (event)=>{
        if(event.name==="word" || event.charIndex!==undefined){
          highlightByCharIndex(event.charIndex||0);
        }
      };

      synth.speak(utter);
    }

    function stop(){
      synth.cancel();
      clearHighlights();
      clearInterval(fallbackTimer);
    }

    // Autoplay attempt
    function tryAutoplay(){
      setTimeout(()=>{
        speak();
        setTimeout(()=>{
          if(!synth.speaking){
            showStartOverlay();
          }
        },1500);
      },800);
    }

    function showStartOverlay(){
      if(document.getElementById("startOverlay")) return;
      const overlay=document.createElement("div");
      overlay.id="startOverlay";
      const btn=document.createElement("button");
      btn.textContent="ðŸ”Š Tap to Listen";
      btn.onclick=()=>{
        overlay.remove();
        speak();
      };
      overlay.appendChild(btn);
      document.body.appendChild(overlay);
    }

    window.addEventListener("load", tryAutoplay);
  </script>

</body>
</html>
